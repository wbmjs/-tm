name: ğŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹è®¢é˜…

on:
  # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–ï¼Œæå‡è¿è¡Œé€Ÿåº¦

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # æ—  requirements.txt æ—¶è‡ªåŠ¨å®‰è£… requests
          if [ ! -f "requirements.txt" ]; then
            pip install requests>=2.31.0
          else
            pip install -r requirements.txt
          fi

      - name: ğŸŒ è·å–æœ€æ–°èŠ‚ç‚¹
        id: fetch
        run: |
          # æ‰§è¡Œæ­£ç¡®çš„ Python è„šæœ¬å¹¶è¾“å‡ºåˆ°æ–‡ä»¶
          python fetch_nodes.py > nodes.txt
          # å°†æ–‡ä»¶å†…å®¹å†™å…¥ç¯å¢ƒå˜é‡ï¼Œé¿å…ç©ºå†…å®¹
          echo "NODE_CONTENT=$(cat nodes.txt | tr -d '\r')" >> $GITHUB_ENV
        env:
          INVITE_CODE: ${{ secrets.INVITE_CODE }}
        continue-on-error: true  # è„šæœ¬æ‰§è¡Œå¤±è´¥ä¸ä¸­æ–­æµç¨‹

      - name: ğŸ“¤ æ›´æ–°åˆ° Gist
        if: env.NODE_CONTENT != ''  # å†…å®¹éç©ºæ‰æ›´æ–°
        uses: exuanbo/actions-deploy-gist@v1.1.0
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: ./nodes.txt  # æœ¬åœ°æ–‡ä»¶è·¯å¾„
          gist_file_name: nodes.txt  # Gist ä¸­æ˜¾ç¤ºçš„æ–‡ä»¶å
        continue-on-error: false
