name: ğŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹è®¢é˜…

on:
  # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–ï¼Œæå‡é€Ÿåº¦

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # è‹¥ä¸å­˜åœ¨ requirements.txtï¼Œç›´æ¥å®‰è£… requests
          if [ ! -f "requirements.txt" ]; then
            pip install requests>=2.31.0
          else
            pip install -r requirements.txt
          fi

      - name: ğŸŒ è·å–æœ€æ–°èŠ‚ç‚¹
        id: fetch
        run: |
          # æ‰§è¡Œæ­£ç¡®çš„è„šæœ¬æ–‡ä»¶
          python main.py > nodes.txt
          # å°†æ–‡ä»¶å†…å®¹å†™å…¥ç¯å¢ƒå˜é‡ï¼Œé¿å… readFile é”™è¯¯
          echo "NODE_CONTENT=$(cat nodes.txt | tr -d '\r')" >> $GITHUB_ENV
        env:
          INVITE_CODE: ${{ secrets.INVITE_CODE }}
        continue-on-error: true  # è„šæœ¬æ‰§è¡Œå¤±è´¥æ—¶ä¸ä¸­æ–­ workflow

      - name: ğŸ“¤ æ›´æ–°åˆ° Gist
        if: env.NODE_CONTENT != ''  # å†…å®¹éç©ºæ—¶æ‰æ›´æ–°
        uses: exuanbo/actions-gist@v1.1.0
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          files: |
            {
              "nodes.txt": {
                "content": "${{ env.NODE_CONTENT }}"
              }
            }
        continue-on-error: false
